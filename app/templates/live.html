{% extends 'base.html' %}

{% block title %}Glimpser - Live View{% endblock %}

{% block extra_head %}
<style>
    .video-container { 
        width: 100%;
        height: 80vh; /* 80% of the viewport height */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden; /* Prevents scrolling */
    }
    #live-video, #live-image {
        max-height: 100%;
        max-width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="video-container">
    <img id="live-image" style="width: 100%;">
    <video id="live-video" style="width: 100%; display: none;" controls autoplay muted></video>
    <div id="video-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
        <div id="loading-indicator" style="display: none;">Loading...</div>
        <div id="play-pause-indicator" style="display: none; font-size: 48px;">▶</div>
    </div>
</div>

<select id="camera-selector" onchange="changeCamera()">
    <option value="All" title="View all cameras">All</option>
    {% set all_groups = [] %}
    {% for camera, details in template_details.items() %}
        {% if details.groups %}
            {% for group in details.groups.split(',') %}
                {% if group %}
                    {% set _ = all_groups.append(group|trim) %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    {% for group in all_groups|unique|sort %}
        <option value="group-{{ group }}" title="View cameras in group {{ group }}">Group: {{ group }}</option>
    {% endfor %}
    {% for camera in template_details.keys()|sort %}
        <option value="{{ camera }}" title="View camera {{ camera }}">Camera: {{ camera }}</option>
    {% endfor %}
</select>

<select id="video-source" onchange="changeVideoSource()">
    <option value="png" title="View a series of PNG images">PNG Stream</option>
    <option value="m3u8" title="View an HLS (HTTP Live Streaming) video stream">M3U8 Stream</option>
    <option value="loop" title="Loop through available video clips">Loop Videos</option>
    <option value="mp4" selected title="View an MP4 video stream">MP4 Stream</option>
    <option value="motion" title="View motion-detected frames">Motion</option>
    <option value="mjpg" title="View an MJPEG (Motion JPEG) stream">MJPG</option>
</select>

<div>
    <input type="range" id="speed-slider" min="-3" max="4" value="0" step="0.1" oninput="updatePlaybackSpeed()">
    <label for="speed-slider">Playback Speed: <span id="speed-value">1x</span></label>
</div>

<div id="template-details"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    const video = document.getElementById('live-video');
    const image = document.getElementById('live-image');
    const templateDetailsContainer = document.getElementById('template-details');
    const templateDetails = {{ template_details|tojson }};
    let currentCamera = 'All'; // Set the default camera to "All"
    let pngInterval;
    const videoOverlay = document.getElementById('video-overlay');
    const loadingIndicator = document.getElementById('loading-indicator');
    const playPauseIndicator = document.getElementById('play-pause-indicator');

    function showLoadingIndicator() {
        videoOverlay.style.display = 'block';
        loadingIndicator.style.display = 'block';
        playPauseIndicator.style.display = 'none';
    }

    function hideLoadingIndicator() {
        loadingIndicator.style.display = 'none';
        if (videoOverlay.style.display === 'block') {
            setTimeout(() => {
                videoOverlay.style.display = 'none';
            }, 500);
        }
    }

    function showPlayPauseIndicator(isPaused) {
        videoOverlay.style.display = 'block';
        playPauseIndicator.style.display = 'block';
        playPauseIndicator.textContent = isPaused ? '▶' : '❚❚';
        loadingIndicator.style.display = 'none';
        setTimeout(() => {
            playPauseIndicator.style.display = 'none';
            if (loadingIndicator.style.display === 'none') {
                videoOverlay.style.display = 'none';
            }
        }, 500);
    }

    video.addEventListener('waiting', showLoadingIndicator);
    video.addEventListener('canplay', hideLoadingIndicator);
    video.addEventListener('play', () => showPlayPauseIndicator(false));
    video.addEventListener('pause', () => showPlayPauseIndicator(true));

    function changeCamera() {
        // Function implementation remains the same
    }

    function updateTemplateDetails() {
        // Function implementation remains the same
    }

    function updateFeed() {
        // Function implementation remains the same
    }

    function playM3U8() {
        // Function implementation remains the same
    }

    function playLoop() {
        // Function implementation remains the same
    }

    function refreshPNG() {
        // Function implementation remains the same
    }

    function playMP4() {
        // Function implementation remains the same
    }

    function playPNG() {
        // Function implementation remains the same
    }

    function playMJPG() {
        // Function implementation remains the same
    }

    function playMotion() {
        // Function implementation remains the same
    }

    function changeVideoSource() {
        updateFeed();
    }

    function updatePlaybackSpeed() {
        // Function implementation remains the same
    }

    // Initially update template details and play the MP4 stream
    updateTemplateDetails();
    playMP4();
</script>
{% endblock %}


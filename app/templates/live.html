{% include 'header.html' %}

<body>
    <header>
        {% include 'nav.html' %}
    </header>

    <style>
        .video-container {
            width: 100%;
            height: 80vh; /* 80% of the viewport height */
            position: relative;
            overflow: hidden; /* Prevents scrolling */
        }
        #live-video, #live-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .video-container:hover .video-controls {
            opacity: 1;
        }
        .video-controls button {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
        }
        .video-controls button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #seek-bar, #volume-bar {
            width: 100px;
            margin: 0 10px;
        }
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>

    <div class="video-container">
        <video id="live-video" controls>
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="video-controls">
            <button id="play-pause" class="control-button">
                <span class="play-icon">▶</span>
                <span class="pause-icon" style="display: none;">❚❚</span>
            </button>
            <input type="range" id="seek-bar" value="0" class="seek-bar">
            <button id="full-screen" class="control-button">⛶</button>
        </div>
        <div id="loading-indicator" class="loading-indicator" style="display: none;">Loading...</div>
        <div id="error-message" class="error-message"></div>
    </div>

    <div class="player-options">
        <select id="camera-selector" onchange="changeCamera()">
            <option value="All" title="View all cameras">All</option>
            {% set all_groups = [] %}
            {% for camera, details in template_details.items() %}
                {% if details.groups %}
                    {% for group in details.groups.split(',') %}
                        {% if group %}
                            {% set _ = all_groups.append(group|trim) %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
            {% for group in all_groups|unique|sort %}
                <option value="group-{{ group }}" title="View cameras in group {{ group }}">Group: {{ group }}</option>
            {% endfor %}
            {% for camera in template_details.keys()|sort %}
                <option value="{{ camera }}" title="View camera {{ camera }}">Camera: {{ camera }}</option>
            {% endfor %}
        </select>

        <select id="video-source" onchange="changeVideoSource()">
            <option value="png" title="View a series of PNG images">PNG Stream</option>
            <option value="m3u8" title="View an HLS (HTTP Live Streaming) video stream">M3U8 Stream</option>
            <option value="loop" title="Loop through available video clips">Loop Videos</option>
            <option value="mp4" selected title="View an MP4 video stream">MP4 Stream</option>
            <option value="motion" title="View motion-detected frames">Motion</option>
            <option value="mjpg" title="View an MJPEG (Motion JPEG) stream">MJPG</option>
        </select>

        <div class="speed-control">
            <input type="range" id="speed-slider" min="-3" max="4" value="0" step="0.1" oninput="updatePlaybackSpeed()">
            <label for="speed-slider">Speed: <span id="speed-value">1x</span></label>
        </div>
    </div>

    <div id="template-details"></div>

    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        const video = document.getElementById('live-video');
        const templateDetailsContainer = document.getElementById('template-details');
        const templateDetails = {{ template_details|tojson }};
        let currentCamera = 'All'; // Set the default camera to "All"
        let pngInterval;
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const playPauseButton = document.getElementById('play-pause');
        const playIcon = playPauseButton.querySelector('.play-icon');
        const pauseIcon = playPauseButton.querySelector('.pause-icon');
        const seekBar = document.getElementById('seek-bar');
        const fullScreenButton = document.getElementById('full-screen');

        function showLoadingIndicator() {
            loadingIndicator.style.display = 'block';
        }

        function hideLoadingIndicator() {
            loadingIndicator.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        video.addEventListener('waiting', showLoadingIndicator);
        video.addEventListener('canplay', hideLoadingIndicator);
        video.addEventListener('play', updatePlayPauseButton);
        video.addEventListener('pause', updatePlayPauseButton);
        video.addEventListener('error', (e) => showError('Error loading video: ' + e.target.error.message));

        function updatePlayPauseButton() {
            if (video.paused) {
                playIcon.style.display = 'inline';
                pauseIcon.style.display = 'none';
            } else {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'inline';
            }
        }

        playPauseButton.addEventListener('click', () => {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        });

        seekBar.addEventListener('input', () => {
            const time = video.duration * (seekBar.value / 100);
            video.currentTime = time;
        });

        video.addEventListener('timeupdate', () => {
            const value = (100 / video.duration) * video.currentTime;
            seekBar.value = value;
        });

        fullScreenButton.addEventListener('click', () => {
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.mozRequestFullScreen) {
                video.mozRequestFullScreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            }
        });

        function changeCamera() {
            showLoadingIndicator();
            const cameraSelector = document.getElementById('camera-selector');
            const selectedValue = cameraSelector.value;
            if (selectedValue === 'All') {
                currentCamera = 'All';
                templateDetails['All'] = {
                    url: '/stream.mp4',
                    groupCameras: Object.keys(templateDetails).filter(key => key !== 'All'),
                };
            } else if (selectedValue.startsWith('group-')) {
                const groupName = selectedValue.split('group-')[1];
                currentCamera = 'group-' + groupName;
                const groupCameras = Object.entries(templateDetails)
                    .filter(([camera, details]) => details.groups && details.groups.split(',').map(s => s.trim()).includes(groupName))
                    .map(([camera, _]) => camera);
                templateDetails[currentCamera] = {
                    url: `/stream.mp4?group=${groupName}`,
                    groupCameras: groupCameras,
                    groupName: groupName,
                };
            } else {
                currentCamera = selectedValue;
            }

            const isConnected = checkCameraConnection(currentCamera);

            if (!isConnected) {
                const videoContainer = document.querySelector('.video-container');
                videoContainer.innerHTML = `
                    <div class="placeholder">
                        <img src="/static/img/camera_offline.png" alt="Camera Offline">
                        <p>Camera ${currentCamera} is currently offline</p>
                    </div>
                `;
                hideLoadingIndicator();
            } else {
                updateTemplateDetails();
                updateFeed();
            }
        }

        function updateTemplateDetails() {
            const details = templateDetails[currentCamera];
            const isConnected = checkCameraConnection(currentCamera);

            if (details) {
                video.title = details.last_caption;
                templateDetailsContainer.innerHTML = `
                    <h3>Details for ${currentCamera}</h3>
                    <p>Status: ${isConnected ? '<span class="connected">Connected</span>' : '<span class="disconnected">Disconnected</span>'}</p>
                    <p>URL: ${details.url}</p>
                    <p>Frequency: ${details.frequency} minutes</p>
                    <p>Timeout: ${details.timeout} seconds</p>
                    <p>Notes: ${details.notes || 'N/A'}</p>
                    <p>Last Screenshot Time: ${details.last_screenshot_time || 'N/A'}</p>
                    <p>Last Caption: ${details.last_caption || 'N/A'}</p>
                `;

                if (!isConnected) {
                    templateDetailsContainer.innerHTML += `
                        <p class="error-message">This camera appears to be offline. Last seen: ${details.last_screenshot_time || 'Never'}</p>
                    `;
                }
            } else {
                templateDetailsContainer.innerHTML = `
                    <h3>Details for ${currentCamera}</h3>
                    <p>No details available</p>
                `;
            }
        }

        function updateFeed() {
            const source = document.getElementById('video-source').value;
            const isConnected = checkCameraConnection(currentCamera);

            if (!isConnected) {
                const videoContainer = document.querySelector('.video-container');
                videoContainer.innerHTML = `
                    <div class="placeholder">
                        <img src="/static/img/camera_offline.png" alt="Camera Offline">
                        <p>Camera ${currentCamera} is currently offline</p>
                    </div>
                `;
                hideLoadingIndicator();
                return;
            }

            switch (source) {
                case 'm3u8':
                    playM3U8();
                    break;
                case 'loop':
                    playLoop();
                    break;
                case 'png':
                    playPNG();
                    break;
                case 'mp4':
                    playMP4();
                    break;
                case 'mjpg':
                    playMJPG();
                    break;
                case 'motion':
                    playMotion();
                    break;
                default:
                    console.error('Invalid video source');
            }
        }

        // ... (keep the existing playM3U8, playLoop, playPNG, playMP4, playMJPG, and playMotion functions)

        function changeVideoSource() {
            updateFeed();
        }

        function updatePlaybackSpeed() {
            const slider = document.getElementById('speed-slider');
            const speedDisplay = document.getElementById('speed-value');
            const speed = Math.pow(2, slider.value);
            video.playbackRate = parseFloat(speed.toFixed(2));
            speedDisplay.textContent = speed.toFixed(2) + 'x';

            if (pngInterval) {
                clearInterval(pngInterval);
                pngInterval = setInterval(refreshPNG, 1000 / speed);
            }

            speedDisplay.classList.add('highlight-speed');
            setTimeout(() => speedDisplay.classList.remove('highlight-speed'), 500);
        }

        function checkCameraConnection(cameraName) {
            const camera = templateDetails[cameraName];
            if (!camera || !camera.last_screenshot_time) {
                return false;
            }

            const lastScreenshotTime = new Date(camera.last_screenshot_time);
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            return lastScreenshotTime > oneHourAgo;
        }

        updateTemplateDetails();
        playMP4();
    </script>

    {% include 'footer.html' %}
</body>
</html>


<!-- app/templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Glimpser Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</head>
<body>
	<header>
	{% include 'nav.html' %}
	</header>

<details>
    <summary>Add Template</summary>
    <div id="template-form" style="background-color: #222; padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto;">
        <h3 style="color: #fff; text-align: center; margin-bottom: 20px;">Add Template</h3>
        <form id="add-template-form" action="/templates" method="post" onsubmit="return validateForm()">
            <div class="form-grid">
                <label for="name">Template Name: *</label>
                <input type="text" id="name" name="name" required title="Enter a unique name for this template">

                <label for="url">URL: *</label>
                <input type="url" id="url" name="url" required title="Enter the full URL to be monitored">

                <label for="frequency">Frequency (minutes): *</label>
                <input type="number" id="frequency" name="frequency" value="30" min="1" required title="How often the template should be checked, in minutes">

                <label for="timeout">Timeout (seconds): *</label>
                <input type="number" id="timeout" name="timeout" value="10" min="1" required title="Maximum time to wait for a response, in seconds">

                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes" title="Optional notes about this template"></textarea>

                <label for="object_filter">Object Filter:</label>
                <input type="text" id="object_filter" name="object_filter" title="Comma-separated list of objects to detect">

                <label for="object_confidence">Object Confidence:</label>
                <input type="number" id="object_confidence" name="object_confidence" min="0" max="1" step="0.01" title="Confidence threshold for object detection (0-1)">

                <label for="popup_xpath">Popup XPath:</label>
                <input type="text" id="popup_xpath" name="popup_xpath" title="XPath to identify and close popups">

                <label for="dedicated_xpath">Dedicated XPath:</label>
                <input type="text" id="dedicated_xpath" name="dedicated_xpath" title="XPath to focus on a specific element">

                <label for="callback_url">Callback URL:</label>
                <input type="url" id="callback_url" name="callback_url" title="URL to receive notifications">

                <label for="proxy">Proxy:</label>
                <input type="text" id="proxy" name="proxy" title="Proxy server to use (e.g., http://proxy.example.com:8080)">

                <label for="groups">Groups:</label>
                <input type="text" id="groups" name="groups" title="Comma-separated list of groups this template belongs to">

                <label for="rollback_frames">Rollback Frames:</label>
                <input type="number" id="rollback_frames" name="rollback_frames" value="0" min="0" title="Number of frames to roll back when detecting changes">
            </div>

            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <label for="invert" style="color: #fff;">
                    <input type="checkbox" id="invert" name="invert"> Invert
                </label>
                <label for="dark" style="color: #fff;">
                    <input type="checkbox" id="dark" name="dark" checked> Dark Mode
                </label>
                <label for="headless" style="color: #fff;">
                    <input type="checkbox" id="headless" name="headless" checked> Headless
                </label>
                <label for="stealth" style="color: #fff;">
                    <input type="checkbox" id="stealth" name="stealth"> Stealth
                </label>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <input type="submit" value="Submit" style="padding: 10px 20px; background-color: #4CAF50; color: #fff; border: none; border-radius: 5px; cursor: pointer;">
            </div>
        </form>
    </div>
</details>

<script>
function validateForm() {
    const name = document.getElementById('name').value.trim();
    const url = document.getElementById('url').value.trim();
    const frequency = document.getElementById('frequency').value;
    const timeout = document.getElementById('timeout').value;
    const objectConfidence = document.getElementById('object_confidence').value;
    const groups = document.getElementById('groups').value.trim();
    let isValid = true;
    let errorMessage = "";

    // Reset all error styles
    document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

    if (name === "") {
        document.getElementById('name').classList.add('error');
        errorMessage += "Template Name is required.\n";
        isValid = false;
    }

    if (url === "") {
        document.getElementById('url').classList.add('error');
        errorMessage += "URL is required.\n";
        isValid = false;
    } else if (!isValidUrl(url)) {
        document.getElementById('url').classList.add('error');
        errorMessage += "Please enter a valid URL.\n";
        isValid = false;
    }

    if (frequency < 1) {
        document.getElementById('frequency').classList.add('error');
        errorMessage += "Frequency must be at least 1 minute.\n";
        isValid = false;
    }

    if (timeout < 1) {
        document.getElementById('timeout').classList.add('error');
        errorMessage += "Timeout must be at least 1 second.\n";
        isValid = false;
    }

    if (objectConfidence !== "" && (objectConfidence < 0 || objectConfidence > 1)) {
        document.getElementById('object_confidence').classList.add('error');
        errorMessage += "Object Confidence must be between 0 and 1.\n";
        isValid = false;
    }

    if (groups !== "" && !isValidGroupFormat(groups)) {
        document.getElementById('groups').classList.add('error');
        errorMessage += "Groups must be comma-separated alphanumeric values.\n";
        isValid = false;
    }

    if (!isValid) {
        alert(errorMessage);
    }

    return isValid;
}

function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

function isValidGroupFormat(string) {
    return /^[a-zA-Z0-9]+(,[a-zA-Z0-9]+)*$/.test(string);
}
</script>

<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

<div>
    <label for="group-dropdown">Filter by Group:</label>

    <select id="group-dropdown">
        <!-- Options will be populated here -->
    </select>

    <input type="range" id="grid-width-slider" min="50" max="3840" value="360" onload="this.max = window.innerWidth;">
    <button id="play-all">Play All</button>
    <button id="stop-all">Stop All</button>
</div>

<div id="template-list">
    <!-- Template list will be populated here -->
</div>

{% include 'footer.html' %}
</body>
</html>


<!-- app/templates/template_details.html -->

{% include 'header.html' %} 

<body>
	<header>
    {% include 'nav.html' %} 
	</header>
    <h2>Screenshots for 
	    <a href='{{template_details.url}}'>{{ template_name }}</a>
    </h2>


    <button id="instant-screenshot-btn" onclick="takeInstantScreenshot('{{ template_name }}')" title="Take a screenshot of the template immediately">Take Instant Screenshot</button>
    <button id="update-video-btn" onclick="updateVideo('{{ template_name }}')" title="Update the video for this template">Update Video</button>
    <button id="show-camera-details-btn" onclick="showCameraDetails('{{ template_name }}')" title="Show camera details and endpoints">Show Camera Details</button>
    <br/>


    </script>

            <video controls poster="/last_screenshot/{{ template_name }}" autoplay muted autoplay style='max-height: 100%; max-width: 100%;' width='100%'
			    {% if template_details.last_caption %}
			    title='{{template_details.last_caption}}'
			    {% else %}
			    title='Latest video capture for this template'
			    {% endif %}
		    >

            <source src="/last_video/{{template_name}}" type='video/mp4'>
            </video >

             <script>
                const video = document.querySelector('video');
                video.addEventListener('loadedmetadata', () => {
                    // Set playback speed based on video duration
                    if (video.duration < 1) {
                        video.playbackRate = 0.0625;
                    } else if (video.duration < 3) {
                        video.playbackRate = 0.0625*2;
                    } else if (video.duration < 7) {
                        video.playbackRate = 0.0625*4;
                    } else if (video.duration < 15) {
                        video.playbackRate = 0.0625*8;
                    } else if (video.duration < 30) {
                        video.playbackRate = 0.0625*16;
                    } else if (video.duration < 60) {
                        video.playbackRate = 0.0625*32;
                    } else if (video.duration > 120) {
                        video.playbackRate = 0.0625*64;
                    } else {
                        video.playbackRate = 0.0625*128;
                    }

                    // Start the video at t minus 10 seconds if possible
                    video.currentTime = Math.max(0, video.duration - 10);
                });

video.addEventListener('ended', () => {
        const pauseTime = calculatePauseTime(video.duration);
    setTimeout(() => {
        video.load(); // Reset the video to show the poster
        video.play(); // Resume autoplay after 1 second
    }, pauseTime); // Pause for 1 second
});

function calculatePauseTime(duration) {
    if (duration < 1) {
        return 10000; // 10 seconds for videos shorter than 1 second
    } else if (duration > 120) {
        return 3000; // 3 seconds for videos longer than 2 minutes
    } else {
        // For videos between 1 second and 2 minutes, calculate a pause time that decreases with duration
        // This is just an example calculation, you can adjust the formula as needed
        return 10000 - (duration - 1) * (7000 / 119);
    }
}
             </script>



<script>
function takeInstantScreenshot(templateName) {
    fetch(`/take_screenshot/${templateName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({}) // Empty body for POST request
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            // Optionally refresh the page or update the UI to show the new screenshot
            location.reload(); // Simple page refresh
        }
    })
    .catch(error => console.error('Error taking instant screenshot:', error));
}

function updateVideo(templateName) {
    fetch(`/update_video/${templateName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({}) // Empty body for POST request
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            // Optionally refresh the page or update the UI to show the new screenshot
            location.reload(); // Simple page refresh
        }
    })
    .catch(error => console.error('Error taking instant screenshot:', error));
}

</script>


  <details title="View recent videos for this template"><summary>Recent Videos</summary>
    <div id="videos">
        {% for video in videos %}
            <div class="video">
                <video src="/videos/{{template_name}}/{{video}}" height="200" autoplay loop muted title="Recent video capture: {{video}}"></video>
            </div>
        {% endfor %}
    </div>
  </details>

    <details title="View recent screenshots for this template"><summary>Recent Captures</summary>
    <div id="screenshots">
        {% for screenshot in screenshots %}
            <div class="screenshot">
                    <a href='/screenshots/{{template_name}}/{{screenshot}}' title="View full-size screenshot"><img src="/screenshots/{{template_name}}/{{screenshot }}" alt="Screenshot" height='200' title="Recent screenshot: {{screenshot}}"></a>
            </div>
        {% endfor %}
    </div>
  </details>



<div>
    <a href="{{ url_for('edit_template', template_name=template_name) }}" class="btn btn-primary" title="Edit this template">Edit Template</a>
</div>

<div id="delete-template" style="text-align: center; margin-top: 20px;">
    <button id="delete-btn" onclick="confirmDelete('{{ template_name }}')" style="padding: 10px 20px; background-color: #e74c3c; color: #fff; border: none; border-radius: 5px; cursor: pointer;" title="Delete this template permanently">Delete Template</button>
</div>

<script>
function confirmDelete(templateName) {
    const confirmed = confirm("Are you sure you want to delete this template?");
    if (confirmed) {
        // Send a DELETE request to the server
        fetch('/templates', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: templateName })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if(data.status === 'success') {
                window.location.href = '/'; // Redirect to the homepage or another appropriate page
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function showCameraDetails(templateName) {
    const baseUrl = window.location.origin;
    const details = {
        'Camera Name': templateName,
        'Last Screenshot URL': `${baseUrl}/last_screenshot/${templateName}`,
        'Last Video URL': `${baseUrl}/last_video/${templateName}`,
        'Stream URL': `${baseUrl}/stream.mjpg?group=${templateName}`,
        'Motion Stream URL': `${baseUrl}/motion.mjpg?group=${templateName}`,
        'Caption Stream URL': `${baseUrl}/caption.mjpg?group=${templateName}`,
        'Motion Caption Stream URL': `${baseUrl}/motion_caption.mjpg?group=${templateName}`,
        'Template Details URL': `${baseUrl}/templates/${templateName}`
    };

    let detailsHtml = '<h3>Camera Details</h3><pre>';
    for (const [key, value] of Object.entries(details)) {
        detailsHtml += `${key}: ${value}\n`;
    }
    detailsHtml += '</pre>';
    detailsHtml += '<button onclick="copyToClipboard()">Copy to Clipboard</button>';

    document.getElementById('camera-details-content').innerHTML = detailsHtml;
    document.getElementById('camera-details-modal').style.display = 'block';
}

function copyToClipboard() {
    const detailsText = document.querySelector('#camera-details-content pre').innerText;
    navigator.clipboard.writeText(detailsText).then(() => {
        alert('Camera details copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

function closeModal() {
    document.getElementById('camera-details-modal').style.display = 'none';
}
</script>

<details><summary>Metadata</summary>
    {{template_details}}
</details>

{% include 'footer.html' %}

<div id="camera-details-modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
        <span onclick="closeModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <div id="camera-details-content"></div>
    </div>
</div>
</body>
</html>


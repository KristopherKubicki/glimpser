<!-- app/templates/template_details.html -->

{% include 'header.html' %} 

<body>
	<header>
    {% include 'nav.html' %} 
	</header>
    <h2>Screenshots for 
	    <a href='{{template_details.url}}'>{{ template_name }}</a>
    </h2>


    <button id="instant-screenshot-btn" onclick="takeInstantScreenshot('{{ template_name }}')" title="Take a screenshot of the template immediately">Take Instant Screenshot</button>
    <button id="update-video-btn" onclick="updateVideo('{{ template_name }}')" title="Update the video for this template">Update Video</button>
    <button id="show-camera-details-btn" onclick="showCameraDetails('{{ template_name }}')" title="Show camera details and endpoints">Show Camera Details</button>
    <br/>


    </script>

            <video controls poster="/last_screenshot/{{ template_name }}" autoplay muted autoplay style='max-height: 100%; max-width: 100%;' width='100%'
			    {% if template_details.last_caption %}
			    title='{{template_details.last_caption}}'
			    {% else %}
			    title='Latest video capture for this template'
			    {% endif %}
		    >

            <source src="/last_video/{{template_name}}" type='video/mp4'>
            </video >

             <script>
                const video = document.querySelector('video');
                video.addEventListener('loadedmetadata', () => {
                    // Set playback speed based on video duration
                    if (video.duration < 1) {
                        video.playbackRate = 0.0625;
                    } else if (video.duration < 3) {
                        video.playbackRate = 0.0625*2;
                    } else if (video.duration < 7) {
                        video.playbackRate = 0.0625*4;
                    } else if (video.duration < 15) {
                        video.playbackRate = 0.0625*8;
                    } else if (video.duration < 30) {
                        video.playbackRate = 0.0625*16;
                    } else if (video.duration < 60) {
                        video.playbackRate = 0.0625*32;
                    } else if (video.duration > 120) {
                        video.playbackRate = 0.0625*64;
                    } else {
                        video.playbackRate = 0.0625*128;
                    }

                    // Start the video at t minus 10 seconds if possible
                    video.currentTime = Math.max(0, video.duration - 10);
                });

video.addEventListener('ended', () => {
        const pauseTime = calculatePauseTime(video.duration);
    setTimeout(() => {
        video.load(); // Reset the video to show the poster
        video.play(); // Resume autoplay after 1 second
    }, pauseTime); // Pause for 1 second
});

function calculatePauseTime(duration) {
    if (duration < 1) {
        return 10000; // 10 seconds for videos shorter than 1 second
    } else if (duration > 120) {
        return 3000; // 3 seconds for videos longer than 2 minutes
    } else {
        // For videos between 1 second and 2 minutes, calculate a pause time that decreases with duration
        // This is just an example calculation, you can adjust the formula as needed
        return 10000 - (duration - 1) * (7000 / 119);
    }
}
             </script>



<script>
function takeInstantScreenshot(templateName) {
    fetch(`/take_screenshot/${templateName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({}) // Empty body for POST request
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            // Optionally refresh the page or update the UI to show the new screenshot
            location.reload(); // Simple page refresh
        }
    })
    .catch(error => console.error('Error taking instant screenshot:', error));
}

function updateVideo(templateName) {
    fetch(`/update_video/${templateName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({}) // Empty body for POST request
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            // Optionally refresh the page or update the UI to show the new screenshot
            location.reload(); // Simple page refresh
        }
    })
    .catch(error => console.error('Error taking instant screenshot:', error));
}

</script>


  <details title="View recent videos for this template"><summary>Recent Videos</summary>
    <div id="videos">
        {% for video in videos %}
            <div class="video">
                <video src="/videos/{{template_name}}/{{video}}" height="200" autoplay loop muted title="Recent video capture: {{video}}"></video>
            </div>
        {% endfor %}
    </div>
  </details>

    <details title="View recent screenshots for this template"><summary>Recent Captures</summary>
    <div id="screenshots">
        {% for screenshot in screenshots %}
            <div class="screenshot">
                    <a href='/screenshots/{{template_name}}/{{screenshot}}' title="View full-size screenshot"><img src="/screenshots/{{template_name}}/{{screenshot }}" alt="Screenshot" height='200' title="Recent screenshot: {{screenshot}}"></a>
            </div>
        {% endfor %}
    </div>
  </details>



<details title="Edit the details of this template">
    <summary>Edit Template</summary>
    <div id="edit-template" style="background-color: #222; padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto;">
        <h3 style="color: #fff; text-align: center; margin-bottom: 20px;">Edit Template Details</h3>
        <form id="edit-template-form" action="/update_template/{{ template_name }}" method="post" onsubmit="return validateForm()" title="Form to edit template details">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 20px;">
                <label for="url" style="color: #fff;" title="URL to monitor">URL:</label>
                <input type="url" id="url" name="url" value="{{ template_details.url }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" required title="Enter the URL to monitor">

                <label for="frequency" style="color: #fff;" title="How often to check the URL">Frequency (minutes):</label>
                <input type="number" id="frequency" name="frequency" value="{{ template_details.frequency }}" min="1" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" required title="Enter how often to check the URL (in minutes)">

                <label for="timeout" style="color: #fff;" title="Maximum time to wait for a response">Timeout (seconds):</label>
                <input type="number" id="timeout" name="timeout" value="{{ template_details.timeout }}" min="1" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" required title="Enter the maximum time to wait for a response (in seconds)">

                <label for="notes" style="color: #fff;" title="Additional notes">Notes:</label>
                <textarea id="notes" name="notes" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter any additional notes or comments">{{ template_details.notes }}</textarea>

                <label for="object_filter" style="color: #fff;" title="Filter for specific objects">Object Filter:</label>
                <input type="text" id="object_filter" name="object_filter" value="{{ template_details.object_filter }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter object types to filter (e.g., 'person,car')">

                <label for="object_confidence" style="color: #fff;" title="Minimum confidence for object detection">Object Confidence:</label>
                <input type="number" id="object_confidence" name="object_confidence" value="{{ template_details.object_confidence }}" min="0" max="1" step="0.01" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter the minimum confidence level for object detection (0-1)">

                <label for="motion" style="color: #fff;" title="Percentage of motion required to trigger an alert">Motion Percent:</label>
                <input type="number" id="motion" name="motion" value="{{ template_details.motion }}" min="0" max="100" step="1" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter the percentage of motion required to trigger an alert">

                <label for="popup_xpath" style="color: #fff;">Popup XPath:</label>
                <div class="xpath-input-container">
                    <input type="text" id="popup_xpath" name="popup_xpath" value="{{ template_details.popup_xpath }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 70%;">
                    <button type="button" onclick="showStructuredInput('popup_xpath')" style="padding: 5px; border-radius: 5px; background-color: #4CAF50; color: #fff; border: none; cursor: pointer;">Structured</button>
                </div>

                <label for="dedicated_xpath" style="color: #fff;">Dedicated XPath:</label>
                <div class="xpath-input-container">
                    <input type="text" id="dedicated_xpath" name="dedicated_xpath" value="{{ template_details.dedicated_xpath }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 70%;">
                    <button type="button" onclick="showStructuredInput('dedicated_xpath')" style="padding: 5px; border-radius: 5px; background-color: #4CAF50; color: #fff; border: none; cursor: pointer;">Structured</button>
                </div>

                <label for="callback_url" style="color: #fff;" title="URL for notifications">Callback URL:</label>
                <input type="url" id="callback_url" name="callback_url" value="{{ template_details.callback_url }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter URL to receive notifications">

                <label for="proxy" style="color: #fff;" title="Proxy server address">Proxy:</label>
                <input type="text" id="proxy" name="proxy" value="{{ template_details.proxy }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter proxy server address (optional)">

                <label for="groups" style="color: #fff;" title="Groups for the template">Groups:</label>
                <input type="text" id="groups" name="groups" value="{{ template_details.groups }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter comma-separated group names">

                <label for="rollback_frames" style="color: #fff;" title="Number of frames to rollback">Rollback Frames:</label>
                <input type="number" id="rollback_frames" name="rollback_frames" value="{{ template_details.rollback_frames or 0 }}" min="0" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;" title="Enter number of frames to rollback">
            </div>

            <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <label for="invert" style="color: #fff;" title="Invert image colors">
                    <input type="checkbox" id="invert" name="invert" {% if template_details.invert %}checked{% endif %} title="Invert colors of the captured image"> Invert
                </label>
                <label for="dark" style="color: #fff;" title="Use dark mode">
                    <input type="checkbox" id="dark" name="dark" {% if template_details.dark %}checked{% endif %} title="Enable dark mode for the captured page"> Dark Mode
                </label>
                <label for="browser" style="color: #fff;" title="Use a full browser">
                    <input type="checkbox" id="browser" name="browser" {% if template_details.browser %}checked{% endif %} title="Use a full browser instead of a headless one"> Browser
                </label>
                <label for="headless" style="color: #fff;" title="Run in headless mode">
                    <input type="checkbox" id="headless" name="headless" {% if template_details.headless %}checked{% endif %} title="Run browser in headless mode"> Headless
                </label>
                <label for="stealth" style="color: #fff;" title="Use stealth mode">
                    <input type="checkbox" id="stealth" name="stealth" {% if template_details.stealth %}checked{% endif %} title="Use stealth mode to avoid detection"> Stealth
                </label>
                <label for="danger" style="color: #fff;" title="Mark as potentially dangerous">
                    <input type="checkbox" id="danger" name="danger" {% if template_details.danger %}checked{% endif %} title="Mark this template as potentially dangerous"> Danger
                </label>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <input type="submit" value="Update Template" style="padding: 10px 20px; background-color: #4CAF50; color: #fff; border: none; border-radius: 5px; cursor: pointer;" title="Save changes to this template">
            </div>
        </form>
    </div>

    <div id="delete-template" style="text-align: center; margin-top: 20px;">
        <button id="delete-btn" onclick="confirmDelete('{{ template_name }}')" style="padding: 10px 20px; background-color: #e74c3c; color: #fff; border: none; border-radius: 5px; cursor: pointer;" title="Delete this template permanently">Delete Template</button>
    </div>
</details>

<script>
function validateForm() {
    const frequency = document.getElementById('frequency').value;
    const timeout = document.getElementById('timeout').value;
    const objectConfidence = document.getElementById('object_confidence').value;

    if (frequency < 1) {
        alert("Frequency must be at least 1 minute.");
        return false;
    }

    if (timeout < 1) {
        alert("Timeout must be at least 1 second.");
        return false;
    }

    if (objectConfidence !== "" && (objectConfidence < 0 || objectConfidence > 1)) {
        alert("Object Confidence must be between 0 and 1.");
        return false;
    }

    return true;
}

function showStructuredInput(inputId) {
    const input = document.getElementById(inputId);
    const structuredInputHtml = `
        <div class="structured-xpath-input">
            <select id="${inputId}_tag">
                <option value="div">div</option>
                <option value="span">span</option>
                <option value="a">a</option>
                <option value="p">p</option>
                <option value="*">*</option>
            </select>
            <select id="${inputId}_attribute">
                <option value="class">class</option>
                <option value="id">id</option>
                <option value="name">name</option>
                <option value="data-*">data-*</option>
            </select>
            <input type="text" id="${inputId}_value" placeholder="Attribute value">
            <button type="button" onclick="generateXPath('${inputId}')">Generate XPath</button>
        </div>
    `;
    input.insertAdjacentHTML('afterend', structuredInputHtml);
    input.style.display = 'none';
}

function generateXPath(inputId) {
    const tag = document.getElementById(`${inputId}_tag`).value;
    const attribute = document.getElementById(`${inputId}_attribute`).value;
    const value = document.getElementById(`${inputId}_value`).value;
    
    let xpath = `//${tag}`;
    if (attribute === 'data-*') {
        xpath += `[starts-with(@data-,'${value}')]`;
    } else {
        xpath += `[contains(@${attribute},'${value}')]`;
    }
    
    document.getElementById(inputId).value = xpath;
    document.getElementById(inputId).style.display = 'block';
    document.querySelector(`#${inputId} + .structured-xpath-input`).remove();
}
</script>


<script>
function confirmDelete(templateName) {
    const confirmed = confirm("Are you sure you want to delete this template?");
    if (confirmed) {
        // Send a DELETE request to the server
        fetch('/templates', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: templateName })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if(data.status === 'success') {
                window.location.href = '/'; // Redirect to the homepage or another appropriate page
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function showCameraDetails(templateName) {
    const baseUrl = window.location.origin;
    const details = {
        'Camera Name': templateName,
        'Last Screenshot URL': `${baseUrl}/last_screenshot/${templateName}`,
        'Last Video URL': `${baseUrl}/last_video/${templateName}`,
        'Stream URL': `${baseUrl}/stream.mjpg?group=${templateName}`,
        'Motion Stream URL': `${baseUrl}/motion.mjpg?group=${templateName}`,
        'Caption Stream URL': `${baseUrl}/caption.mjpg?group=${templateName}`,
        'Motion Caption Stream URL': `${baseUrl}/motion_caption.mjpg?group=${templateName}`,
        'Template Details URL': `${baseUrl}/templates/${templateName}`
    };

    let detailsHtml = '<h3>Camera Details</h3><pre>';
    for (const [key, value] of Object.entries(details)) {
        detailsHtml += `${key}: ${value}\n`;
    }
    detailsHtml += '</pre>';
    detailsHtml += '<button onclick="copyToClipboard()">Copy to Clipboard</button>';

    document.getElementById('camera-details-content').innerHTML = detailsHtml;
    document.getElementById('camera-details-modal').style.display = 'block';
}

function copyToClipboard() {
    const detailsText = document.querySelector('#camera-details-content pre').innerText;
    navigator.clipboard.writeText(detailsText).then(() => {
        alert('Camera details copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

function closeModal() {
    document.getElementById('camera-details-modal').style.display = 'none';
}
</script>

  <details title="View the most recent capture for this template" open><summary>Most Recent Capture</summary>
          <div id="timestamp-container" title="Time since the last capture"></div>

    <script>
                    function timeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);

            if (seconds < 60) {
                return `${seconds} seconds ago`;
            } else if (minutes < 60) {
                return `${minutes} minutes ago`;
            } else if (hours < 24) {
                return `${hours} hours ago`;
            } else if (days < 30) {
                return `${days} days ago`;
            } else if (months < 12) {
                return `${months} months ago`;
            } else if (years < 1000) {
                return `${years} years ago`;
            }
                            return 'never'
        }

const timestampContainer = document.getElementById('timestamp-container');
            const formattedTimestamp = timeAgo('{{template_details['last_screenshot_time']}}');
        timestampContainer.innerHTML = formattedTimestamp;
   </script>


  </details>




  <details><summary>Metadata</summary>
	  {{template_details}}
  </details>

  {% include 'footer.html' %}

  <div id="camera-details-modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
      <span onclick="closeModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      <div id="camera-details-content"></div>
    </div>
  </div>
</body>
</html>

